{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-lg-8 mx-auto">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Chat with {{ remote_user.full_name or remote_user.email }}</strong>
        <div class="d-flex align-items-center gap-2">
          <select id="language-select" class="form-select form-select-sm" style="width: auto;">
            <option value="en">English</option>
            <option value="fr">Français</option>
            <option value="ar">العربية</option>
          </select>
          <a class="btn btn-sm btn-outline-secondary" href="/">Back</a>
        </div>
      </div>
      <div class="card-body p-0 d-flex flex-column" style="height:60vh;">
        <div id="messages" class="flex-grow-1 overflow-auto p-3 small bg-light"></div>
        <form id="chat-form" class="border-top p-2 d-flex gap-2">
          <select id="input-language" class="form-select" style="width: 120px;">
            <option value="en">EN</option>
            <option value="fr">FR</option>
            <option value="ar">AR</option>
          </select>
          <input id="message-input" autocomplete="off" class="form-control" placeholder="Type a message" />
          <button class="btn btn-primary" type="submit">Send</button>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const token = JSON.parse('{{ token|tojson|safe }}');
  const otherUserId = JSON.parse('{{ remote_user.id|tojson|safe }}');
  const currentUserId = JSON.parse('{{ current_user.id|tojson|safe }}');
  const currentUserName = '{{ current_user.full_name or current_user.email }}';
  const otherUserName = '{{ remote_user.full_name or remote_user.email }}';
  const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
  const wsUrl = `${wsProtocol}://${location.host}/ws/chat/${otherUserId}?token=${encodeURIComponent(token)}`;
  const socket = new WebSocket(wsUrl);
  const box = document.getElementById('messages');
  let userLanguage = 'en'; // Default user language preference

  // Language selection change handler
  document.getElementById('language-select').addEventListener('change', function(e) {
    userLanguage = e.target.value;
    // Reload chat history with new language preference
    loadChatHistory();
  });

  function addSystem(text){
    const d=document.createElement('div');
    d.className='text-muted small mb-1';
    d.textContent=text; box.appendChild(d); box.scrollTop=box.scrollHeight;
  }

  function getDisplayText(originalText, originalLang, translationsCache) {
    // If user's language matches original language, return original
    if (userLanguage === originalLang) {
      return { text: originalText, isTranslated: false };
    }
    
    // If translation exists, return it
    if (translationsCache && translationsCache[userLanguage]) {
      return { text: translationsCache[userLanguage], isTranslated: true };
    }
    
    // Return original as fallback
    return { text: originalText, isTranslated: false };
  }

  function addMessage(senderId, senderEmail, originalText, originalLang = 'en', translationsCache = {}){
    const mine = Number(senderId) === Number(currentUserId);
    const wrap=document.createElement('div');
    wrap.className='mb-1 d-flex '+(mine?'justify-content-end':'justify-content-start');
    const bubble=document.createElement('div');
    bubble.className='px-2 py-1 rounded '+(mine?'bg-primary text-white':'bg-white border');
    bubble.style.maxWidth='70%';
    const label = mine ? 'You' : senderEmail;
    
    // Get appropriate text to display
    const displayData = getDisplayText(originalText, originalLang, translationsCache);
    const displayText = displayData.text;
    
    // Create message content
    let messageContent = '<strong class="me-1">'+label+':</strong>'+displayText;
    
    // Add language indicator and original text if translated
    if (displayData.isTranslated) {
      messageContent += `<br><small class="text-muted opacity-75">Translated from ${originalLang.toUpperCase()}: ${originalText}</small>`;
    } else if (originalLang !== 'en') {
      messageContent += `<br><small class="text-muted opacity-75">${originalLang.toUpperCase()}</small>`;
    }
    
    bubble.innerHTML = messageContent;
    wrap.appendChild(bubble); box.appendChild(wrap); box.scrollTop=box.scrollHeight;
  }

  socket.onopen=()=>addSystem('[Connected]');
  socket.onclose=()=>addSystem('[Disconnected]');
  socket.onmessage=(ev)=>{
    try {
      const data = JSON.parse(ev.data);
      if(data.system){ addSystem('['+data.event+'] '+(data.user.email || data.user.id)); return; }
      if(!data.sender){ addSystem('[Missing sender]'); return; }
      addMessage(
        data.sender.id, 
        data.sender.name || data.sender.email, 
        data.original_text,
        data.original_language || 'en',
        data.translations_cache || {}
      );
    } catch(err){ console.error('WS error', err, ev.data); addSystem('[Bad message]'); }
  };

  document.getElementById('chat-form').addEventListener('submit', e=>{
    e.preventDefault();
    const inp=document.getElementById('message-input');
    const inputLang=document.getElementById('input-language').value;
    const t=inp.value.trim();
    if(!t) return; 
    
    // Send message with language information
    const messageData = {
      text: t,
      language: inputLang,
      auto_translate: true
    };
    
    socket.send(JSON.stringify(messageData)); 
    inp.value='';
  });

  function loadChatHistory() {
    // Clear existing messages
    box.innerHTML = '';
    
    fetch(`/api/chat/history/${otherUserId}`, {headers:{'Authorization':`Bearer ${token}`}})
      .then(r=>r.ok?r.json():[])
      .then(rows=>{ 
        rows.forEach(m=> addMessage(
          m.sender_id, 
          m.sender_id===currentUserId?currentUserName:otherUserName, 
          m.original_text,
          m.original_language || 'en',
          m.translations_cache || {}
        )); 
      })
      .catch(()=>{});
  }

  // Load initial chat history
  loadChatHistory();
})();
</script>
{% endblock %}
